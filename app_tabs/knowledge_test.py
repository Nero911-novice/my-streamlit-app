import streamlit as st
import time


def knowledge_test_tab():
    """–í–∫–ª–∞–¥–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–Ω–∞–Ω–∏–π"""
    if "visited_tabs" not in st.session_state:
        st.session_state.visited_tabs = set()
    st.session_state.visited_tabs.add("–ü—Ä–æ–≤–µ—Ä—å —Å–≤–æ–∏ –∑–Ω–∞–Ω–∏—è")

    st.header("–ü—Ä–æ–≤–µ—Ä—å —Å–≤–æ–∏ –∑–Ω–∞–Ω–∏—è")
    st.markdown("–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ç–µ—Å—Ç –¥–ª—è –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è –∏–∑—É—á–µ–Ω–Ω–æ–≥–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞.")

    if 'test_score' not in st.session_state:
        st.session_state.test_score = 0
        st.session_state.test_completed = False
        st.session_state.current_question = 0

    questions = [
        {
            "question": "–°–æ–≥–ª–∞—Å–Ω–æ –∑–∞–∫–æ–Ω—É —Ç—Ä—ë—Ö —Å–∏–≥–º, –∫–∞–∫–æ–π –ø—Ä–æ—Ü–µ–Ω—Ç –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –¥–∏–∞–ø–∞–∑–æ–Ω ¬±2œÉ?",
            "options": ["68%", "95%", "99.7%", "50%"],
            "correct": 1,
            "explanation": "–°–æ–≥–ª–∞—Å–Ω–æ –∑–∞–∫–æ–Ω—É —Ç—Ä—ë—Ö —Å–∏–≥–º, 95% –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ–ø–∞–¥–∞—é—Ç –≤ –¥–∏–∞–ø–∞–∑–æ–Ω ¬±2œÉ –æ—Ç —Å—Ä–µ–¥–Ω–µ–≥–æ."
        },
        {
            "question": "–ß—Ç–æ —É—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –ø—Ä–µ–¥–µ–ª—å–Ω–∞—è —Ç–µ–æ—Ä–µ–º–∞?",
            "options": [
                "–í—Å–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —è–≤–ª—è—é—Ç—Å—è –Ω–æ—Ä–º–∞–ª—å–Ω—ã–º–∏",
                "–°—Ä–µ–¥–Ω–µ–µ –±–æ–ª—å—à–æ–π –≤—ã–±–æ—Ä–∫–∏ —Ä–∞–≤–Ω–æ —Å—Ä–µ–¥–Ω–µ–º—É –ø–æ–ø—É–ª—è—Ü–∏–∏",
                "–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤—ã–±–æ—Ä–æ—á–Ω—ã—Ö —Å—Ä–µ–¥–Ω–∏—Ö –ø—Ä–∏–±–ª–∏–∂–∞–µ—Ç—Å—è –∫ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–º—É",
                "–î–∏—Å–ø–µ—Ä—Å–∏—è —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è —Å —É–≤–µ–ª–∏—á–µ–Ω–∏–µ–º –≤—ã–±–æ—Ä–∫–∏"
            ],
            "correct": 2,
            "explanation": "–¶–ü–¢ —É—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç, —á—Ç–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤—ã–±–æ—Ä–æ—á–Ω—ã—Ö —Å—Ä–µ–¥–Ω–∏—Ö –ø—Ä–∏–±–ª–∏–∂–∞–µ—Ç—Å—è –∫ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–º—É –ø—Ä–∏ —É–≤–µ–ª–∏—á–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –≤—ã–±–æ—Ä–∫–∏."
        },
        {
            "question": "–ß—Ç–æ —Ç–∞–∫–æ–µ —Ä–µ–≥—Ä–µ—Å—Å–∏—è –∫ —Å—Ä–µ–¥–Ω–µ–º—É?",
            "options": [
                "–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –º–µ—Ç–æ–¥ –∞–Ω–∞–ª–∏–∑–∞",
                "–¢–µ–Ω–¥–µ–Ω—Ü–∏—è —ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –±—ã—Ç—å –±–ª–∏–∂–µ –∫ —Å—Ä–µ–¥–Ω–µ–º—É –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –∏–∑–º–µ—Ä–µ–Ω–∏–∏",
                "–°–ø–æ—Å–æ–± –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Å—Ä–µ–¥–Ω–µ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è",
                "–¢–∏–ø —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è"
            ],
            "correct": 1,
            "explanation": "–†–µ–≥—Ä–µ—Å—Å–∏—è –∫ —Å—Ä–µ–¥–Ω–µ–º—É ‚Äî —Ñ–µ–Ω–æ–º–µ–Ω, –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–º —ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –∏–∑–º–µ—Ä–µ–Ω–∏–∏ —Å—Ç—Ä–µ–º—è—Ç—Å—è –±–ª–∏–∂–µ –∫ —Å—Ä–µ–¥–Ω–µ–º—É –ø–æ–ø—É–ª—è—Ü–∏–∏."
        },
        {
            "question": "–ó–∞–∫–æ–Ω –±–æ–ª—å—à–∏—Ö —á–∏—Å–µ–ª —É—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç, —á—Ç–æ:",
            "options": [
                "–ë–æ–ª—å—à–∏–µ —á–∏—Å–ª–∞ –≤—Å–µ–≥–¥–∞ —Ç–æ—á–Ω–µ–µ –º–∞–ª—ã—Ö",
                "–ü—Ä–∏ —É–≤–µ–ª–∏—á–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –≤—ã–±–æ—Ä–∫–∏ —Å—Ä–µ–¥–Ω–µ–µ —Å—Ç—Ä–µ–º–∏—Ç—Å—è –∫ –∏—Å—Ç–∏–Ω–Ω–æ–º—É —Å—Ä–µ–¥–Ω–µ–º—É –ø–æ–ø—É–ª—è—Ü–∏–∏",
                "–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –≤—Å–µ–≥–¥–∞ —Ä–∞–≤–Ω–∞ 0.5",
                "–ë–æ–ª—å—à–∏–µ –≤—ã–±–æ—Ä–∫–∏ –≤—Å–µ–≥–¥–∞ –Ω–æ—Ä–º–∞–ª—å–Ω–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω—ã"
            ],
            "correct": 1,
            "explanation": "–ó–ë–ß –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ —Å —É–≤–µ–ª–∏—á–µ–Ω–∏–µ–º —Ä–∞–∑–º–µ—Ä–∞ –≤—ã–±–æ—Ä–∫–∏ –≤—ã–±–æ—Ä–æ—á–Ω–æ–µ —Å—Ä–µ–¥–Ω–µ–µ —Å—Ö–æ–¥–∏—Ç—Å—è –∫ –∏—Å—Ç–∏–Ω–Ω–æ–º—É —Å—Ä–µ–¥–Ω–µ–º—É –ø–æ–ø—É–ª—è—Ü–∏–∏."
        },
        {
            "question": "–ö–∞–∫–∞—è –æ—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ —Å –º–∞–ª—ã–º–∏ –≤—ã–±–æ—Ä–∫–∞–º–∏?",
            "options": [
                "–û–Ω–∏ –≤—Å–µ–≥–¥–∞ –¥–∞—é—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã",
                "–û–Ω–∏ –∏–º–µ—é—Ç –≤—ã—Å–æ–∫—É—é –≤–∞—Ä–∏–∞–±–µ–ª—å–Ω–æ—Å—Ç—å –∏ –Ω–µ–Ω–∞–¥–µ–∂–Ω—ã–µ –æ—Ü–µ–Ω–∫–∏",
                "–û–Ω–∏ –Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã –≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ",
                "–û–Ω–∏ –≤—Å–µ–≥–¥–∞ –∏–º–µ—é—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ"
            ],
            "correct": 1,
            "explanation": "–ú–∞–ª—ã–µ –≤—ã–±–æ—Ä–∫–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏–∑—É—é—Ç—Å—è –≤—ã—Å–æ–∫–æ–π –≤–∞—Ä–∏–∞–±–µ–ª—å–Ω–æ—Å—Ç—å—é –æ—Ü–µ–Ω–æ–∫, —á—Ç–æ –¥–µ–ª–∞–µ—Ç –≤—ã–≤–æ–¥—ã –º–µ–Ω–µ–µ –Ω–∞–¥–µ–∂–Ω—ã–º–∏."
        }
    ]

    if not st.session_state.test_completed:
        current_q = questions[st.session_state.current_question]
        st.subheader(f"–í–æ–ø—Ä–æ—Å {st.session_state.current_question + 1} –∏–∑ {len(questions)}")
        st.write(current_q["question"])
        answer = st.radio("–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–≤–µ—Ç:", current_q["options"], key=f"q_{st.session_state.current_question}")
        if st.button("–û—Ç–≤–µ—Ç–∏—Ç—å"):
            selected_idx = current_q["options"].index(answer)
            if selected_idx == current_q["correct"]:
                st.success("‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ! " + current_q["explanation"])
                st.session_state.test_score += 1
            else:
                st.error("‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ. " + current_q["explanation"])
            st.session_state.current_question += 1
            if st.session_state.current_question >= len(questions):
                st.session_state.test_completed = True
                st.rerun()
            else:
                time.sleep(2)
                st.rerun()
    else:
        score_pct = (st.session_state.test_score / len(questions)) * 100
        st.subheader("üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞")
        st.write(f"–í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç: **{st.session_state.test_score} –∏–∑ {len(questions)}** ({score_pct:.0f}%)")
        st.progress(score_pct / 100)
        if score_pct >= 80:
            st.success("üèÜ –û—Ç–ª–∏—á–Ω–æ! –í—ã —Ö–æ—Ä–æ—à–æ —É—Å–≤–æ–∏–ª–∏ –º–∞—Ç–µ—Ä–∏–∞–ª!")
        elif score_pct >= 60:
            st.info("üëç –•–æ—Ä–æ—à–æ! –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —Ç–µ–º—ã.")
        else:
            st.warning("üìö –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –∏–∑—É—á–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª –µ—â–µ —Ä–∞–∑.")
        col1, col2 = st.columns(2)
        with col1:
            if st.button("üîÑ –ü—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç –∑–∞–Ω–æ–≤–æ"):
                st.session_state.test_score = 0
                st.session_state.test_completed = False
                st.session_state.current_question = 0
                st.rerun()
        with col2:
            if st.button("üìñ –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∏–∑—É—á–µ–Ω–∏—é"):
                st.info("–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–∫–ª–∞–¥–∫–∏ –≤—ã—à–µ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª–∞!")
