import streamlit as st
import seaborn as sns
import matplotlib.pyplot as plt

from .three_sigma import three_sigma_law_tab
from .central_limit import central_limit_theorem_tab
from .law_of_large_numbers import law_of_large_numbers_tab
from .small_samples import small_samples_tab
from .comparison import comparison_distributions_tab
from .regression import regression_to_mean_tab
from .knowledge_test import knowledge_test_tab
from .distribution_types import distribution_types_tab
from .utils import generate_distribution_data, safe_statistics, create_download_button, format_stat_display

sns.set_theme(style="whitegrid")


def main():
    setup_sidebar()
    st.title("üìä –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–Ω—ã—Ö –∑–∞–∫–æ–Ω–æ–≤")
    tabs = st.tabs([
        "–ó–∞–∫–æ–Ω —Ç—Ä—ë—Ö —Å–∏–≥–º", "–¶–ü–¢", "–ó–ë–ß", "–ú–∞–ª—ã–µ –≤—ã–±–æ—Ä–∫–∏",
        "–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π", "–†–µ–≥—Ä–µ—Å—Å–∏—è –∫ —Å—Ä–µ–¥–Ω–µ–º—É",
        "–ü—Ä–æ–≤–µ—Ä—å —Å–≤–æ–∏ –∑–Ω–∞–Ω–∏—è", "–¢–∏–ø—ã —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π"
    ])
    with tabs[0]:
        three_sigma_law_tab()
    with tabs[1]:
        central_limit_theorem_tab()
    with tabs[2]:
        law_of_large_numbers_tab()
    with tabs[3]:
        small_samples_tab()
    with tabs[4]:
        comparison_distributions_tab()
    with tabs[5]:
        regression_to_mean_tab()
    with tabs[6]:
        knowledge_test_tab()
    with tabs[7]:
        distribution_types_tab()
    setup_footer()


def setup_sidebar():
    with st.sidebar:
        st.header("üìñ –°–ø—Ä–∞–≤–∫–∞ –∏ —Ñ–æ—Ä–º—É–ª—ã")
        references = {
            "–ó–∞–∫–æ–Ω —Ç—Ä—ë—Ö —Å–∏–≥–º": "https://en.wikipedia.org/wiki/68‚Äì95‚Äì99.7_rule",
            "–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –ø—Ä–µ–¥–µ–ª—å–Ω–∞—è —Ç–µ–æ—Ä–µ–º–∞": "https://ru.wikipedia.org/wiki/–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è_–ø—Ä–µ–¥–µ–ª—å–Ω–∞—è_—Ç–µ–æ—Ä–µ–º–∞",
            "–ó–∞–∫–æ–Ω –±–æ–ª—å—à–∏—Ö —á–∏—Å–µ–ª": "https://ru.wikipedia.org/wiki/–ó–∞–∫–æ–Ω_–±–æ–ª—å—à–∏—Ö_—á–∏—Å–µ–ª",
            "–ó–∞–∫–æ–Ω –º–∞–ª—ã—Ö —á–∏—Å–µ–ª": "https://ru.wikipedia.org/wiki/–ó–∞–∫–æ–Ω_–º–∞–ª—ã—Ö_—á–∏—Å–µ–ª_(–ø—Å–∏—Ö–æ–ª–æ–≥–∏—è)",
            "–†–µ–≥—Ä–µ—Å—Å–∏—è –∫ —Å—Ä–µ–¥–Ω–µ–º—É": "https://ru.wikipedia.org/wiki/–†–µ–≥—Ä–µ—Å—Å–∏—è_–∫_—Å—Ä–µ–¥–Ω–µ–º—É"
        }
        descriptions = {
            "–ó–∞–∫–æ–Ω —Ç—Ä—ë—Ö —Å–∏–≥–º": "68-95-99.7% –ø—Ä–∞–≤–∏–ª–æ –¥–ª—è –Ω–æ—Ä–º–∞–ª—å–Ω–æ–≥–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è",
            "–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –ø—Ä–µ–¥–µ–ª—å–Ω–∞—è —Ç–µ–æ—Ä–µ–º–∞": "–ü—Ä–∏ –±–æ–ª—å—à–∏—Ö n —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ä–µ–¥–Ω–∏—Ö —Å—Ç—Ä–µ–º–∏—Ç—Å—è –∫ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–º—É (—Å—Ä–µ–¥–Ω–µ–µ Œº, œÉ/‚àön)",
            "–ó–∞–∫–æ–Ω –±–æ–ª—å—à–∏—Ö —á–∏—Å–µ–ª": "–°—Ä–µ–¥–Ω–µ–µ —Å—Ö–æ–¥–∏—Ç—Å—è –∫ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–º—É –æ–∂–∏–¥–∞–Ω–∏—é –ø—Ä–∏ n‚Üí‚àû",
            "–ó–∞–∫–æ–Ω –º–∞–ª—ã—Ö —á–∏—Å–µ–ª": "–û—à–∏–±–∫–∏ –ø—Ä–∏ –æ–±–æ–±—â–µ–Ω–∏–∏ –º–∞–ª—ã—Ö –≤—ã–±–æ—Ä–æ–∫",
            "–†–µ–≥—Ä–µ—Å—Å–∏—è –∫ —Å—Ä–µ–¥–Ω–µ–º—É": "–û—à–∏–±–∫–∏ –∏–∑-–∑–∞ —ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—ã—Ö –≤—ã–±—Ä–æ—Å–æ–≤"
        }
        for name, url in references.items():
            st.markdown(f"**{name}**\n{descriptions[name]}\n[–°—Ç–∞—Ç—å—è –Ω–∞ Wikipedia]({url})", unsafe_allow_html=True)
        st.markdown("### üî∞ –î–ª—è –Ω–∞—á–∏–Ω–∞—é—â–∏—Ö")
        if st.checkbox("–í–∫–ª—é—á–∏—Ç—å —Å–ø—Ä–∞–≤–æ—á–Ω—ã–π —Ä–µ–∂–∏–º"):
            st.info(
                """**–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º:**
                1. –í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â—É—é –≤–∫–ª–∞–¥–∫—É –≤–≤–µ—Ä—Ö—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å –ø–æ–º–æ—â—å—é —Å–ª–∞–π–¥–µ—Ä–æ–≤ –∏ –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤
                3. –ò–∑—É—á–∏—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–∏–º—É–ª—è—Ü–∏–∏ –∏ –ø—Ä–æ—á–∏—Ç–∞–π—Ç–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è
                4. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ \"–°–∫–∞—á–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫\" –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–π
                –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ —Å —Ä–∞–∑–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å, –∫–∞–∫ –æ–Ω–∏ –≤–ª–∏—è—é—Ç –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã!"""
            )
        with st.expander("üí° –°–æ–≤–µ—Ç—ã"):
            st.markdown(
                """**–°–æ–≤–µ—Ç—ã –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é:**
                * –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–∫–ª–∞–¥–∫–∏ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–µ–∂–¥—É —Ä–∞–∑–Ω—ã–º–∏ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–Ω—ã–º–∏ –∑–∞–∫–æ–Ω–∞–º–∏
                * –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –¥–ª—è –Ω–∞–±–ª—é–¥–µ–Ω–∏—è –∏—Ö –≤–ª–∏—è–Ω–∏—è
                * –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–∞—Ö - –æ–Ω–∏ –æ–±—ä—è—Å–Ω—è—é—Ç –∫–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã
                * –î–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –¶–ü–¢ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —á–µ–∫–±–æ–∫—Å –Ω–∞ –≤–∫–ª–∞–¥–∫–µ –¶–ü–¢
                * –ì—Ä–∞—Ñ–∏–∫ –º–æ–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å, –Ω–∞–≤–µ–¥—è –∫—É—Ä—Å–æ—Ä –∏ –∏—Å–ø–æ–ª—å–∑—É—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
                –ü—Ä–∏ –º–µ–¥–ª–µ–Ω–Ω–æ–π —Ä–∞–±–æ—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø–æ–ø—Ä–æ–±—É–π—Ç–µ:
                * –£–º–µ–Ω—å—à–∏—Ç—å —Ä–∞–∑–º–µ—Ä—ã –≤—ã–±–æ—Ä–æ–∫
                * –£–º–µ–Ω—å—à–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∏–º—É–ª—è—Ü–∏–π
                * –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É"""
            )


def setup_footer():
    try:
        plt.close('all')
    except Exception as e:
        st.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤: {str(e)}")
    if "page_views" not in st.session_state:
        st.session_state.page_views = 0
    st.session_state.page_views += 1
    st.markdown("---")
    col1, col2, col3 = st.columns(3)
    with col1:
        st.markdown("### üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã")
        st.markdown(
            """- [Khan Academy: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞](https://www.khanacademy.org/math/statistics-probability)
- [StatQuest YouTube](https://www.youtube.com/c/joshstarmer)
- [Seeing Theory](https://seeing-theory.brown.edu/)
- [Stattrek Calculators](https://stattrek.com/online-calculator)
- [Coursera: Statistics Courses](https://www.coursera.org/courses?query=statistics)"""
        )
    with col2:
        st.markdown("### ‚ÑπÔ∏è –û –ø—Ä–æ–µ–∫—Ç–µ")
        st.markdown(
            """**–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö –∏ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–Ω—ã—Ö –∫–æ–Ω—Ü–µ–ø—Ü–∏–π.**
            
üéØ **–¶–µ–ª—å:** –°–¥–µ–ª–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ–Ω—è—Ç–Ω–æ–π –∏ –¥–æ—Å—Ç—É–ø–Ω–æ–π —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏

üîß **–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:** Python, Streamlit, NumPy, Matplotlib, SciPy

üìß **–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å:** –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º—É –Ω–∏–∂–µ –¥–ª—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π"""
        )
    with col3:
        st.markdown("### üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è")
        st.metric("–ü—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ —Å–µ—Å—Å–∏–∏", st.session_state.page_views)
        if "visited_tabs" not in st.session_state:
            st.session_state.visited_tabs = set()
        visited_count = len(st.session_state.visited_tabs)
        total_tabs = 8
        progress = visited_count / total_tabs
        st.metric("–ò–∑—É—á–µ–Ω–æ —Ä–∞–∑–¥–µ–ª–æ–≤", f"{visited_count}/{total_tabs}")
        st.progress(progress)
        with st.expander("üìù –û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤"):
            feedback_type = st.selectbox("–¢–∏–ø –æ—Ç–∑—ã–≤–∞:", ["üí° –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ", "üêõ –°–æ–æ–±—â–∏—Ç—å –æ–± –æ—à–∏–±–∫–µ", "üëç –ü–æ—Ö–≤–∞–ª–∏—Ç—å", "‚ùì –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å"])
            feedback = st.text_area("–í–∞—à –æ—Ç–∑—ã–≤:")
            if st.button("–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤") and feedback:
                st.success("–°–ø–∞—Å–∏–±–æ –∑–∞ –æ—Ç–∑—ã–≤! –ú—ã —É—á—Ç–µ–º –≤–∞—à–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –≤ –±—É–¥—É—â–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è—Ö.")
    with st.expander("üìÖ –ò—Å—Ç–æ—Ä–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π"):
        st.markdown(
            """**v3.0 (–î–µ–∫–∞–±—Ä—å 2025) - –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è**
- ‚ö° –ü–æ–ª–Ω—ã–π —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –∫–æ–¥–∞ —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- üöÄ –î–æ–±–∞–≤–ª–µ–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –≤—ã—á–∏—Å–ª–µ–Ω–∏–π (—É—Å–∫–æ—Ä–µ–Ω–∏–µ –≤ 3-5 —Ä–∞–∑)
- üèóÔ∏è –£–ª—É—á—à–µ–Ω–∞ –º–æ–¥—É–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–¥–∞ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∞ —Ç–∏–ø–∏–∑–∞—Ü–∏—è
- üéì –î–æ–±–∞–≤–ª–µ–Ω –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ç–µ—Å—Ç –∑–Ω–∞–Ω–∏–π —Å —Å–∏—Å—Ç–µ–º–æ–π –æ—Ü–µ–Ω–∫–∏
- üìä –†–∞—Å—à–∏—Ä–µ–Ω —Ä–∞–∑–¥–µ–ª —Ç–∏–ø–æ–≤ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π —Å –≤–∏–∑—É–∞–ª—å–Ω—ã–º–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è–º–∏
- üé® –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –≥—Ä–∞—Ñ–∏–∫–∏ –∏ —É–ª—É—á—à–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
- üîß –î–æ–±–∞–≤–ª–µ–Ω–∞ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

**v2.0 (–ò—é–Ω—å 2025)**
- üìà –î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ –º–æ–¥—É–ª–∏: –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π, –†–µ–≥—Ä–µ—Å—Å–∏—è –∫ —Å—Ä–µ–¥–Ω–µ–º—É
- üõ°Ô∏è –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –≤—ã—á–∏—Å–ª–µ–Ω–∏—è

**v1.0 (–ê–ø—Ä–µ–ª—å 2025)**
- üéâ –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–π —Ä–µ–ª–∏–∑ —Å –±–∞–∑–æ–≤—ã–º–∏ –º–æ–¥—É–ª—è–º–∏
- üìä –ë–∞–∑–æ–≤—ã–µ –º–æ–¥—É–ª–∏: –ó–∞–∫–æ–Ω —Ç—Ä—ë—Ö —Å–∏–≥–º, –¶–ü–¢, –ó–ë–ß, –ú–∞–ª—ã–µ –≤—ã–±–æ—Ä–∫–∏"""
        )
    st.markdown("---")
    st.markdown(
        """<div style='text-align: center; color: #666666; font-size: 12px;'>
üí° –°–æ–∑–¥–∞–Ω–æ –¥–ª—è –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö —Ü–µ–ª–µ–π | üî¨ –û—Å–Ω–æ–≤–∞–Ω–æ –Ω–∞ –Ω–∞—É—á–Ω—ã—Ö –ø—Ä–∏–Ω—Ü–∏–ø–∞—Ö —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ |
üéØ –ü–æ–º–æ–≥–∞–µ—Ç –ø–æ–Ω—è—Ç—å —Å–ª–æ–∂–Ω—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
</div>""",
        unsafe_allow_html=True,
    )
