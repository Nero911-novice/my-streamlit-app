import streamlit as st
import numpy as np
import matplotlib.pyplot as plt
from .utils import generate_distribution_data, create_download_button


def three_sigma_law_tab():
    """–í–∫–ª–∞–¥–∫–∞ –∑–∞–∫–æ–Ω–∞ —Ç—Ä—ë—Ö —Å–∏–≥–º"""
    if "visited_tabs" not in st.session_state:
        st.session_state.visited_tabs = set()
    st.session_state.visited_tabs.add("–ó–∞–∫–æ–Ω —Ç—Ä—ë—Ö —Å–∏–≥–º")

    st.header("–ó–∞–∫–æ–Ω —Ç—Ä—ë—Ö —Å–∏–≥–º (—ç–º–ø–∏—Ä–∏—á–µ—Å–∫–æ–µ –ø—Ä–∞–≤–∏–ª–æ)")
    st.markdown(
        """–ó–∞–∫–æ–Ω —Ç—Ä—ë—Ö —Å–∏–≥–º –ø–æ–º–æ–≥–∞–µ—Ç –ø–æ–Ω—è—Ç—å, –∫–∞–∫ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –≤–æ–∫—Ä—É–≥ —Å—Ä–µ–¥–Ω–µ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è.
    –≠—Ç–æ –ø–æ–ª–µ–∑–Ω–æ, –∫–æ–≥–¥–∞ –Ω—É–∂–Ω–æ —Ä–µ—à–∏—Ç—å, –∫–∞–∫–æ–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ —Å—á–∏—Ç–∞—Ç—å –Ω–æ—Ä–º–∞–ª—å–Ω—ã–º, –∞ –∫–∞–∫–æ–µ ‚Äî –≤—ã–±—Ä–æ—Å–æ–º."""
    )

    col1, col2, col3 = st.columns(3)
    with col1:
        mu = st.slider("–°—Ä–µ–¥–Ω–µ–µ (Œº)", 20, 80, 50)
    with col2:
        sigma = st.slider("–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ (œÉ)", 1, 30, 10)
    with col3:
        size = st.slider("–†–∞–∑–º–µ—Ä –≤—ã–±–æ—Ä–∫–∏", 1000, 50000, 10000, step=1000)

    data = generate_distribution_data("–ù–æ—Ä–º–∞–ª—å–Ω–æ–µ", size, mu=mu, sigma=sigma)

    fig, ax = plt.subplots(figsize=(12, 6))
    ax.hist(data, bins=50, density=True, color='lightgray', edgecolor='black', alpha=0.7)

    colors = ['#b2df8a', '#fdbf6f', '#fb9a99']
    labels = ['¬±1œÉ (68%)', '¬±2œÉ (95%)', '¬±3œÉ (99.7%)']
    for i, (color, label) in enumerate(zip(colors, labels), 1):
        ax.axvspan(mu - i * sigma, mu + i * sigma, color=color, alpha=0.3, label=label)
        ax.axvline(mu - i * sigma, color='red', linestyle='--', linewidth=1)
        ax.axvline(mu + i * sigma, color='red', linestyle='--', linewidth=1)

    ymax = ax.get_ylim()[1]
    annotations = [
        ("68% –∑–Ω–∞—á–µ–Ω–∏–π\n(¬±1œÉ)", (mu, ymax * 0.9), (0, -40)),
        ("95% –∑–Ω–∞—á–µ–Ω–∏–π\n(¬±2œÉ)", (mu - 2 * sigma, ymax * 0.6), (-40, -10)),
        ("–ü–æ—á—Ç–∏ –≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è\n–≤ –ø—Ä–µ–¥–µ–ª–∞—Ö ¬±3œÉ", (mu + 2.5 * sigma, ymax * 0.6), (40, -10))
    ]

    for text, xy, xytext in annotations:
        ax.annotate(text, xy=xy, xycoords='data', xytext=xytext,
                    textcoords='offset points', ha='center', va='top',
                    arrowprops=dict(arrowstyle='->', color='black'), fontsize=9)

    ax.set_title(f"–ó–∞–∫–æ–Ω —Ç—Ä—ë—Ö —Å–∏–≥–º (Œº = {mu}, œÉ = {sigma})", fontsize=14)
    ax.set_xlabel("–ó–Ω–∞—á–µ–Ω–∏–µ")
    ax.set_ylabel("–ü–ª–æ—Ç–Ω–æ—Å—Ç—å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏")
    ax.legend()

    fig.tight_layout()
    st.pyplot(fig, use_container_width=True)

    create_download_button(fig, "three_sigma.png")

    st.markdown(
        f"""
    **–ü–æ—è—Å–Ω–µ–Ω–∏–µ**
    –ì—Ä–∞—Ñ–∏–∫ –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç _–∑–∞–∫–æ–Ω —Ç—Ä—ë—Ö —Å–∏–≥–º_, —Å–æ–≥–ª–∞—Å–Ω–æ –∫–æ—Ç–æ—Ä–æ–º—É:
    - –æ–∫–æ–ª–æ **68%** –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ–ø–∞–¥–∞—é—Ç –≤ –¥–∏–∞–ø–∞–∑–æ–Ω ¬±1œÉ –æ—Ç —Å—Ä–µ–¥–Ω–µ–≥–æ
    - –æ–∫–æ–ª–æ **95%** ‚Äî –≤ –¥–∏–∞–ø–∞–∑–æ–Ω ¬±2œÉ
    - –æ–∫–æ–ª–æ **99.7%** ‚Äî –≤ –¥–∏–∞–ø–∞–∑–æ–Ω ¬±3œÉ

    –ó–¥–µ—Å—å: Œº = {mu}, œÉ = {sigma}, n = {size}

    **–ü—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏:**
    –ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ —à–∫–æ–ª—å–Ω—ã–π –∫–ª–∞—Å—Å, –≥–¥–µ —Å—Ä–µ–¥–Ω–∏–π —Ä–æ—Å—Ç –¥–µ—Ç–µ–π 140 —Å–º, –∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ 5 —Å–º:
    - –û–∫–æ–ª–æ 68% –¥–µ—Ç–µ–π –∏–º–µ—é—Ç —Ä–æ—Å—Ç –æ—Ç 135 –¥–æ 145 —Å–º (¬±1œÉ)
    - –ü—Ä–∏–º–µ—Ä–Ω–æ 95% –¥–µ—Ç–µ–π –∏–º–µ—é—Ç —Ä–æ—Å—Ç –æ—Ç 130 –¥–æ 150 —Å–º (¬±2œÉ)
    - –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –≤—Å–µ –¥–µ—Ç–∏ (99.7%) –∏–º–µ—é—Ç —Ä–æ—Å—Ç –æ—Ç 125 –¥–æ 155 —Å–º (¬±3œÉ)

    ---
    üî¥ **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è**:
    - –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–∏ –∫ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–º—É —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—é
    - –ù–µ–ø—Ä–∏–º–µ–Ω–∏–º –∫ —Å–∏–ª—å–Ω–æ —Å–∫–æ—à–µ–Ω–Ω—ã–º, –º—É–ª—å—Ç–∏–ø–∏–∫–æ–≤—ã–º, –¥–∏—Å–∫—Ä–µ—Ç–Ω—ã–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è–º
    - –ù–∞ –º–∞–ª–µ–Ω—å–∫–∏—Ö –≤—ã–±–æ—Ä–∫–∞—Ö –º–æ–∂–µ—Ç –Ω–µ —Å–æ–±–ª—é–¥–∞—Ç—å—Å—è

    üîµ **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞**:
    - –ü—Ä–æ—Å—Ç–æ–π —ç–≤—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –º–µ—Ç–æ–¥ –æ—Ü–µ–Ω–∫–∏ —Ä–∞–∑–±—Ä–æ—Å–∞
    - –û—Å–Ω–æ–≤–∞ –∫–æ–Ω—Ç—Ä–æ–ª—è –∫–∞—á–µ—Å—Ç–≤–∞ (Six Sigma)
    - –õ–µ–≥–∫–æ –≤–∏–∑—É–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –∏ –≤–æ—Å–ø—Ä–∏–Ω–∏–º–∞–µ—Ç—Å—è
    """
    )
